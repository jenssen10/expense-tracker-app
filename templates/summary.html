{% extends "base.html" %}
{% block content %}

<!-- Navigation -->
<nav style="margin-bottom: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
    <a href="/" style="margin-right: 15px;">üè† Home</a>
    <a href="/summary" style="font-weight: bold; margin-right: 15px;">üìä Monthly Summary</a>
    <a href="/charts">üìà Charts</a>
</nav>

<h2>Monthly Summary</h2>

<div style="margin-bottom: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 5px;">
    <label for="monthSelect" style="display: block; margin-bottom: 8px; font-weight: bold;">
        Select Month:
    </label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="month" id="monthSelect" style="padding: 8px; font-size: 16px;">
        <button onclick="loadSummary()" style="padding: 8px 20px;">
            View Summary
        </button>
    </div>
</div>

<!-- Loading & Error Messages -->
<div id="loading" style="display: none; padding: 15px; background: #e3f2fd; border-radius: 5px; margin-bottom: 20px;">
    ‚è≥ Loading summary...
</div>

<div id="error" style="display: none; padding: 15px; background: #ffebee; color: #c62828; border-radius: 5px; margin-bottom: 20px;">
</div>

<!-- Summary Results -->
<div id="summaryResults" style="display: none;">
    <div style="background: #e8f5e9; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">Summary for <span id="displayMonth"></span></h3>
        <div style="font-size: 1.5em; margin: 15px 0;">
            <strong>Total Spent: $<span id="totalAmount">0.00</span></strong>
        </div>
        <div style="color: #666;">
            Number of expenses: <span id="expenseCount">0</span>
        </div>
    </div>

    <h3>Breakdown by Category</h3>
    <div id="categoryBreakdown"></div>
</div>

<script>
// Set default to current month
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7);
    document.getElementById('monthSelect').value = currentMonth;
    loadSummary();
});

async function loadSummary() {
    const month = document.getElementById('monthSelect').value;
    
    if (!month) {
        showError('Please select a month');
        return;
    }

    showLoading();

    try {
        const [summaryRes, categoryRes] = await Promise.all([
            fetch(`/api/summary/${month}`),
            fetch(`/api/summary/${month}/by-category`)
        ]);

        if (!summaryRes.ok || !categoryRes.ok) {
            throw new Error('Failed to fetch data');
        }

        const summaryData = await summaryRes.json();
        const categoryData = await categoryRes.json();

        hideLoading();
        displaySummary(summaryData, categoryData);

    } catch (error) {
        showError('Unable to load summary. Please try again.');
        console.error('Error:', error);
    }
}

function displaySummary(summary, categories) {
    document.getElementById('summaryResults').style.display = 'block';
    document.getElementById('displayMonth').textContent = summary.month;
    document.getElementById('totalAmount').textContent = summary.total.toFixed(2);
    document.getElementById('expenseCount').textContent = summary.count;

    const breakdownDiv = document.getElementById('categoryBreakdown');
    
    if (categories.categories.length === 0) {
        breakdownDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No expenses for this month</p>';
        return;
    }

    let html = '<table><thead><tr><th>Category</th><th>Amount</th><th>Count</th><th>% of Total</th></tr></thead><tbody>';
    
    categories.categories.forEach(cat => {
        const percentage = ((cat.total / summary.total) * 100).toFixed(1);
        html += `
            <tr>
                <td>${cat.category}</td>
                <td>$${cat.total.toFixed(2)}</td>
                <td>${cat.count}</td>
                <td>${percentage}%</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    breakdownDiv.innerHTML = html;
}

function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('summaryResults').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = '‚ùå ' + message;
    errorDiv.style.display = 'block';
    hideLoading();
}
</script>

{% endblock %}
