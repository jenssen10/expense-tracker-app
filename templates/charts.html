{% extends "base.html" %}
{% block content %}

<!-- Navigation -->
<nav style="margin-bottom: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
    <a href="/" style="margin-right: 15px;">üè† Home</a>
    <a href="/summary" style="margin-right: 15px;">üìä Monthly Summary</a>
    <a href="/charts" style="font-weight: bold;">üìà Charts</a>
</nav>

<h2>Expense Analytics</h2>

<!-- Month Selector -->
<div style="margin-bottom: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 5px;">
    <label for="monthPicker" style="display: block; margin-bottom: 8px; font-weight: bold;">
        Select Month:
    </label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="month" id="monthPicker" style="padding: 8px; font-size: 16px;">
        <button onclick="loadCharts()" style="padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
            Load Charts
        </button>
    </div>
    <small style="color: #666; display: block; margin-top: 5px;">
        Choose a month to see your expense breakdown
    </small>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" style="display: none; padding: 15px; background: #e3f2fd; border-radius: 5px; margin-bottom: 20px;">
    ‚è≥ Loading chart data...
</div>

<!-- Error Message -->
<div id="errorMessage" style="display: none; padding: 15px; background: #ffebee; color: #c62828; border-radius: 5px; margin-bottom: 20px;">
</div>

<!-- Summary Stats -->
<div id="summaryStats" style="display: none; margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px;">
    <h3 style="margin-top: 0;">Month Summary</h3>
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div>
            <strong>Total Spent:</strong> $<span id="totalAmount">0</span>
        </div>
        <div>
            <strong>Number of Expenses:</strong> <span id="expenseCount">0</span>
        </div>
        <div>
            <strong>Average per Expense:</strong> $<span id="avgAmount">0</span>
        </div>
    </div>
</div>

<!-- Charts Container -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
    
    <!-- Category Breakdown Chart -->
    <div style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
        <h3>Expenses by Category</h3>
        <canvas id="categoryChart"></canvas>
    </div>
    
    <!-- Total Amount Chart -->
    <div style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
        <h3>Monthly Total</h3>
        <canvas id="totalChart"></canvas>
    </div>
    
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let categoryChart;
let totalChart;

// Set default month to current month
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7);
    document.getElementById('monthPicker').value = currentMonth;
    loadCharts();
});

function showLoading() {
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('summaryStats').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = '‚ùå ' + message;
    errorDiv.style.display = 'block';
    hideLoading();
}

function updateSummaryStats(total, count) {
    document.getElementById('totalAmount').textContent = total.toFixed(2);
    document.getElementById('expenseCount').textContent = count;
    document.getElementById('avgAmount').textContent = count > 0 ? (total / count).toFixed(2) : '0.00';
    document.getElementById('summaryStats').style.display = 'block';
}

async function loadCharts() {
    const month = document.getElementById('monthPicker').value;
    
    if (!month) {
        showError('Please select a month');
        return;
    }

    showLoading();

    try {
        const [summaryRes, categoryRes] = await Promise.all([
            fetch(`/api/summary/${month}`),
            fetch(`/api/summary/${month}/by-category`)
        ]);

        if (!summaryRes.ok || !categoryRes.ok) {
            throw new Error('Failed to fetch data');
        }

        const summaryData = await summaryRes.json();
        const categoryData = await categoryRes.json();

        hideLoading();

        updateSummaryStats(summaryData.total, summaryData.count);
        renderCategoryChart(categoryData);
        renderTotalChart(summaryData);

    } catch (error) {
        showError('Unable to load chart data. Please try again.');
        console.error('Error loading charts:', error);
    }
}

function renderCategoryChart(data) {
    const ctx = document.getElementById('categoryChart');

    if (categoryChart) categoryChart.destroy();

    if (!data.categories || data.categories.length === 0) {
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        const parent = ctx.parentElement;
        parent.innerHTML = '<h3>Expenses by Category</h3><p style="color: #666; padding: 40px 0; text-align: center;">No expenses for this month</p>';
        return;
    }

    const labels = data.categories.map(c => c.category);
    const amounts = data.categories.map(c => c.total);
    const colors = generateColors(labels.length);

    categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: 'Amount ($)',
                data: amounts,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderTotalChart(data) {
    const ctx = document.getElementById('totalChart');

    if (totalChart) totalChart.destroy();

    totalChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [data.month],
            datasets: [{
                label: 'Total Expenses ($)',
                data: [data.total],
                backgroundColor: '#4CAF50',
                borderColor: '#388E3C',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Total: $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

function generateColors(count) {
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    return colors.slice(0, count);
}
</script>

<style>
    button:hover {
        background: #0056b3 !important;
    }

    canvas {
        max-width: 100%;
        height: auto !important;
    }
</style>

{% endblock %}